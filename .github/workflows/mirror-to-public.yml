name: Mirror to Public

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: mirror-${{ github.ref }}
  cancel-in-progress: false

jobs:
  mirror:
    name: Push to public repo
    if: github.repository != 'quikturn-sdk/Logos'
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.PUBLIC_APP_ID }}
          private-key: ${{ secrets.PUBLIC_APP_PRIVATE_KEY }}
          owner: quikturn-sdk

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Remove internal-only directories from history
        run: |
          pip install git-filter-repo
          git filter-repo \
            --invert-paths \
            --path docs/ \
            --path .claude/ \
            --path .qodo/ \
            --force

      - name: Validate token
        env:
          APP_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          if [ -z "${APP_TOKEN}" ]; then
            echo "::error::GitHub App token is empty â€” check that the app is installed on quikturn-sdk org and secrets are set"
            exit 1
          fi
          echo "Token generated successfully (length: ${#APP_TOKEN})"

      - name: Push to public repo
        env:
          APP_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          git remote add public "https://x-access-token:${APP_TOKEN}@github.com/quikturn-sdk/Logos.git"
          git push public main --force --tags
