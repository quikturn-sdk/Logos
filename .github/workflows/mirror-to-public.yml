name: Mirror to Public

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: mirror-${{ github.ref }}
  cancel-in-progress: false

jobs:
  mirror:
    name: Push to public repo
    if: github.repository != 'quikturn-sdk/Logos'
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.PUBLIC_APP_ID }}
          private-key: ${{ secrets.PUBLIC_APP_PRIVATE_KEY }}
          owner: quikturn-sdk

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Remove internal-only directories from history
        run: |
          pip install git-filter-repo
          git filter-repo \
            --invert-paths \
            --path docs/ \
            --path .claude/ \
            --path .qodo/ \
            --force

      - name: Push to public repo
        env:
          APP_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          git remote add public "https://x-access-token:${APP_TOKEN}@github.com/quikturn-sdk/Logos.git"
          git push public main --force --tags

      - name: Sync GitHub Releases to public repo
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Get all releases from EMU repo
          gh api repos/${{ github.repository }}/releases --paginate --jq '.[] | select(.draft == false)' \
            --header "Authorization: token ${{ secrets.GITHUB_TOKEN }}" > /tmp/emu_releases.json || true

          # Get existing releases on public repo
          gh api repos/quikturn-sdk/Logos/releases --paginate --jq '.[].tag_name' > /tmp/public_tags.txt || true

          # Create missing releases on public repo
          cat /tmp/emu_releases.json | jq -c '.' | while read -r release; do
            tag=$(echo "$release" | jq -r '.tag_name')
            name=$(echo "$release" | jq -r '.name')
            body=$(echo "$release" | jq -r '.body')
            prerelease=$(echo "$release" | jq -r '.prerelease')

            # Skip if release already exists on public
            if grep -qxF "$tag" /tmp/public_tags.txt 2>/dev/null; then
              echo "Release $tag already exists on public â€” skipping"
              continue
            fi

            echo "Creating release $tag on public repo"
            gh api repos/quikturn-sdk/Logos/releases \
              -f tag_name="$tag" \
              -f name="$name" \
              -f body="$body" \
              -F prerelease="$prerelease" \
              -F generate_release_notes=false || echo "::warning::Failed to create release $tag"
          done
